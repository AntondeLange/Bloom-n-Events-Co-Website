---
import { buildSrcSet, encodeSrc, withWidthSuffix, DEFAULT_WIDTH } from "../lib/image-utils";

interface Props {
  src: string;
  alt: string;
  class?: string;
  width?: number;
  height?: number;
  sizes?: string;
  loading?: "lazy" | "eager";
  decoding?: "async" | "sync" | "auto";
  fetchpriority?: "high" | "low" | "auto";
}

const {
  src,
  alt,
  class: className,
  width = 1600,
  height = 900,
  sizes = "100vw",
  loading = "lazy",
  decoding = "async",
  fetchpriority,
} = Astro.props as Props;

const fallbackSrc = encodeSrc(withWidthSuffix(src, DEFAULT_WIDTH));
const fallbackSrcSet = buildSrcSet(src);
const avifSrcSet = buildSrcSet(src, "avif");
const webpSrcSet = buildSrcSet(src, "webp");
---

<picture>
  <source type="image/avif" srcset={avifSrcSet} sizes={sizes} />
  <source type="image/webp" srcset={webpSrcSet} sizes={sizes} />
  <img
    src={fallbackSrc}
    srcset={fallbackSrcSet}
    sizes={sizes}
    alt={alt}
    class={className}
    loading={loading}
    decoding={decoding}
    width={width}
    height={height}
    {...(fetchpriority ? { fetchpriority } : {})}
  />
</picture>
